<div class="container my-2">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>
        <%= render "devise/shared/error_messages", resource: resource %>
        <div class="card">
          <div class="card-header">
          <h2><i data-feather="edit-3" class="feather-icon-style4"></i>&nbsp;&nbsp;編集</h2>
          </div>
          <div class="card-body">
            <h5 class="card-title text-center">情報の追加や設定変更</h5>
            <div class="dashboard">
              <ul class="nav nav-tabs" id="dashboard-nav" role="tablist">
                <li class="nav-item">
                  <a class="nav-link active" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="true">プロフィール情報</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" id="setting-tab" data-toggle="tab" href="#setting" role="tab" aria-controls="setting" aria-selected="false">登録情報</a>
                </li>
              </ul>

              <div class="tab-content" id="dashboard-content">
                <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                  <p>多くの情報を盛込むことで治療当事者の治療方針や転院などの参考になります。</p>
                  <table class="table mb-0">
                    <tbody>
                      <tr>
                        <div class="form-group">
                          <th class="profile-item-l"><%= f.label :icon, "アイコン" %><br/></th>
                          <td class="profile-item-r">
                            <div class="img-field-parent">
                              <div id="img_field" onClick="$('#file').click()">
                                <% if @user.icon.attached? %>
                                  <%= image_tag(@user.icon, class:"icon_image_edit") %>
                                <% else %>
                                  <i class="fas fa-camera-retro fa-5x icon-camera"></i>
                                <% end %>
                              </div>
                              <small class="capacity-limit-attention"><small class="text-danger">※最大5MB</small></small>
                            </div><br>

                            <% if false %> deviseの中でどうやって削除paramsを取得するか？
                              <% if @user.icon.attached? %>
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox" name="user[user_icon]" value="off"><span class="small">アイコンを削除</span>
                                  </label>
                                </div>
                              <% end %>
                            <% end %>

                            <p class="text-muted"><span class="text-primary filesize1"></span><span class="text-danger filesize2"></span></p>
                            <small class="text-muted">画像をクリックするとアイコン画像の選択ができます。</small>
                            <%= f.file_field :icon, class: "form-control", style: "display:none;", id: "file" %>
                          </td>
                        </div>
                      </tr>
                      <script>
                        $(function(){
                          $fileField = $('#file')
                        
                          // 選択された画像を取得し表示
                          $($fileField).on('change', $fileField, function(e) {
                            file = e.target.files[0]
                            reader = new FileReader(),
                            $preview = $("#img_field");
                            var imgSize1 = this.files[0].size;
                            var imgSize = imgSize1 / 1000000
                            if(imgSize <= 5) {
                              $('span.filesize1').text("ファイルサイズ: " + imgSize.toFixed(2) + "MB").show();
                              $('span.filesize2').hide();
                            } else {
                              $('span.filesize2').text("ファイルサイズ: " + imgSize.toFixed(2) + "MB！  上限容量の5MBを超えています。").show();
                              $('span.filesize1').hide();
                            }

                            reader.onload = (function(file) {
                              return function(e) {
                                $preview.empty();
                                $preview.append($('<img>').attr({
                                  src: e.target.result,
                                  width: "100%",
                                  class: "preview",
                                  title: file.name
                                }));
                              };
                            })(file);
                            reader.readAsDataURL(file);
                          });
                        });
                      </script>
                      <tr>
                        <div class="form-group">
                          <th><%= f.label :name, "名前" %></th>
                          <td><%= f.text_field :name, class: "form-control" %></td>
                        </div>
                      </tr>
                      <tr>
                        <div class="form-group">
                          <th><%= f.label :birthday, "生年月" %></th>
                          <td>
                          <%= raw sprintf(
                            f.date_select(
                                :birthday,
                                use_month_numbers: true,
                                discard_day: true,
                                start_year:        (Time.now.year - 60),
                                end_year:          (Time.now.year - 18),
                                default:           Date.new(1980, 1, 1),
                                date_separator:    '%s'), # 年月日区切りをそれぞれ指定
                            '年 ') + '月'
                          %><br>
                          <small class="text-muted">生年月は公開されません。</small>
                          </td>
                        </div>
                      </tr>
                      <tr>
                        <div class="form-group">
                          <th><%= f.label :link, "リンク" %></th>
                          <td><%= f.text_field :link, class: "form-control", placeholder: "twitterやブログのURL" %></td>
                        </div>
                      </tr>
                      <tr>
                        <div class="form-group">
                          <th><p><%= f.label :self_introduction, "自己紹介" %></p></th>
                          <td class="px-0"><%= f.text_area :self_introduction, class: "form-control border rounded-lg p-2", rows: "20", placeholder: "妊活から不妊治療へ至る経緯や、ご自身の細かい属性を盛り込みましょう！" %></td>
                        </div>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <div class="tab-pane fade show" id="setting" role="tabpanel" aria-labelledby="setting-tab">
                  <table class="table">
                    <tbody>
                      <tr>
                        <div class="form-group">
                          <th class="profile-item-l"><%= f.label :email, "メールアドレス" %></th>
                          <td class="profile-item-r">
                            <%= f.text_field :email, autofocus: true, autocomplete: "email", class: "form-control" %>
                            <% if devise_mapping.confirmable? && resource.pending_reconfirmation? %>
                              <div><%= resource.unconfirmed_email %>に届いた認証リンク確認することで更新が完了します</div>
                            <% end %>
                          </td>
                        </div>
                      </tr>
                      <tr>
                        <div class="form-group">
                          <th><%= f.label :password, "新パスワード" %></th>
                          <td>
                            <%= f.password_field :password, autocomplete: "new-password", class: "form-control" %>
                            <% if @minimum_password_length %>
                              <small><%= @minimum_password_length %> 文字以上で構成して下さい。変更しない場合は空白のまま更新して下さい</small>
                            <% end %>
                          </td>
                        </div>
                      </tr>
                      <tr>
                        <div class="form-group">
                          <th><%= f.label :password_confirmation, "パスワード確認" %></th>
                          <td>
                            <%= f.password_field :password_confirmation, autocomplete: "new-password", class: "form-control" %>
                            <small>上記と同じパスワードを入力してください</small>
                          </td>
                        </div>
                      </tr>
                      
                      <tr>
                        <div class="form-group">
                          <th><%= f.label :gender, "性別" %></th>
                          <td>
                            <%= f.label :female, "女" %>
                            <%= f.radio_button :gender, :female, class: "mr-3" %>
                            <%= f.label :male, "男" %>
                            <%= f.radio_button :gender, :male %>
                          </td>
                        </div>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="actions">
              <%= f.submit "更新", class: "btn btn-raised btn-primary mx-auto d-block w-50 mt-md-5 mt-sm-3" %>
            </div>
          </div>
        </div>
      <% end %>  
    </div>
  </div>
</div>